<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªÅ xu·∫•t ƒë·ªãa ƒëi·ªÉm du l·ªãch theo th·ªùi gian th·ª±c</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .panel {
            flex: 1;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .product-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .product-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            width: calc(33% - 15px);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .product-card::after {
            content: "üìç"; /* Map pin emoji */
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 16px;
            opacity: 0.7;
        }
        .product-card:hover::after {
            opacity: 1;
        }
        .recommendation-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .rec-item {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            position: relative;
        }
        .rec-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #ddd;
        }
        .rec-item[style*="cursor: pointer"]::after {
            content: "üìç"; /* Map pin emoji */
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 16px;
            opacity: 0.7;
        }
        .rec-item:hover[style*="cursor: pointer"]::after {
            opacity: 1;
        }
        .user-controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .actions {
            margin-top: 10px;
        }
        button {
            padding: 8px 12px;
            margin-right: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #e9e9e9;
        }
        .log-panel {
            height: 150px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .category {
            display: inline-block;
            background-color: #f0f8ff;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            color: #1e90ff;
            margin: 5px 0;
        }
        .address {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }
        h3 {
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .view-btn {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .cart-btn {
            background-color: #e8f5e9;
            color: #1b5e20;
        }
        .purchase-btn {
            background-color: #fff3e0;
            color: #e65100;
        }
        .view-btn:hover {
            background-color: #bbdefb;
        }
        .cart-btn:hover {
            background-color: #c8e6c9;
        }
        .purchase-btn:hover {
            background-color: #ffe0b2;
        }
        #map {
            height: 300px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>    <h1>ƒê·ªÅ xu·∫•t ƒë·ªãa ƒëi·ªÉm du l·ªãch theo th·ªùi gian th·ª±c</h1>
    
    <div class="user-controls">
        <label for="user-id">ID Ng∆∞·ªùi d√πng:</label>
        <input type="number" id="user-id" value="1">        <button id="connect-btn">K·∫øt n·ªëi</button>
        <button id="disconnect-btn" disabled>Ng·∫Øt k·∫øt n·ªëi</button>
        <span id="connection-status">ƒê√£ ng·∫Øt k·∫øt n·ªëi</span>
    </div>
    
    <div class="container">        <div class="panel">
            <h2>C√°c ƒë·ªãa ƒëi·ªÉm</h2>
            <div class="product-list" id="product-list">
                <!-- Products will be loaded here -->
                <div class="product-card" data-id="1">
                    <h3>ƒêang t·∫£i d·ªØ li·ªáu...</h3>
                </div>
                <!-- More products will be dynamically added -->
            </div>
        </div>
        
        <div class="panel">
            <h2>ƒê·ªÅ xu·∫•t theo th·ªùi gian th·ª±c</h2>
            <div class="recommendation-list" id="recommendation-list">
                <!-- Recommendations will appear here -->
                <div class="rec-item">
                    <p>K·∫øt n·ªëi ng∆∞·ªùi d√πng ƒë·ªÉ xem ƒë·ªÅ xu·∫•t theo th·ªùi gian th·ª±c</p>
                </div>
            </div>
        </div>
    </div>    <h2>B·∫£n ƒë·ªì ƒë·ªãa ƒëi·ªÉm</h2>
    <div id="map"></div>
    
    <h2>Nh·∫≠t k√Ω s·ª± ki·ªán</h2>
    <div class="log-panel" id="log-panel"></div>
    
    <script>
        // Globals
        let socket;
        let connected = false;
        let userId = 1;
        const apiBaseUrl = 'http://localhost:5000'; // Change this to your server URL

        // DOM Elements
        const userIdInput = document.getElementById('user-id');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const productList = document.getElementById('product-list');
        const recommendationList = document.getElementById('recommendation-list');
        const logPanel = document.getElementById('log-panel');

        // Connect to Socket.IO server
        function connectSocket() {
            userId = parseInt(userIdInput.value);
            if (!userId) {
                logMessage('Vui l√≤ng nh·∫≠p ID ng∆∞·ªùi d√πng h·ª£p l·ªá', 'error');
                return;
            }

            try {
                socket = io(apiBaseUrl);
                
                socket.on('connect', () => {
                    logMessage(`ƒê√£ k·∫øt n·ªëi socket v·ªõi ID: ${socket.id}`, 'info');
                    
                    // Register user ID
                    socket.emit('register_user', { user_id: userId });
                });
                
                socket.on('registration_success', (data) => {
                    logMessage(`${data.message}`, 'success');
                    connected = true;
                    updateConnectionUI();
                    
                    // Load initial recommendations
                    fetchRecommendations(userId);
                });
                
                socket.on('registration_failed', (data) => {
                    logMessage(`ƒêƒÉng k√Ω kh√¥ng th√†nh c√¥ng: ${data.message}`, 'error');
                    socket.disconnect();
                });
                
                socket.on('disconnect', () => {
                    logMessage('Socket ƒë√£ ng·∫Øt k·∫øt n·ªëi', 'info');
                    connected = false;
                    updateConnectionUI();
                });
                
                socket.on('realtime_recommendation', (data) => {
                    logMessage(`ƒê√£ nh·∫≠n ƒë·ªÅ xu·∫•t theo th·ªùi gian th·ª±c cho ng∆∞·ªùi d√πng ${data.user_id}`, 'success');
                    displayRecommendations(data.recommendations);
                });
                
                socket.on('connect_error', (error) => {
                    logMessage(`L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                });
                
            } catch (error) {
                logMessage(`L·ªói k·∫øt n·ªëi socket: ${error.message}`, 'error');
            }
        }

        // Disconnect from Socket.IO server
        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                logMessage('ƒê√£ ng·∫Øt k·∫øt n·ªëi t·ª´ m√°y ch·ªß', 'info');
            }
        }

        // Update UI based on connection status
        function updateConnectionUI() {
            if (connected) {                connectionStatus.textContent = `ƒê√£ k·∫øt n·ªëi v·ªõi ng∆∞·ªùi d√πng ${userId}`;
                connectionStatus.style.color = 'green';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                connectionStatus.textContent = 'ƒê√£ ng·∫Øt k·∫øt n·ªëi';
                connectionStatus.style.color = 'red';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // Log message to console
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // Fetch product data
        async function fetchProducts() {
            try {
                // Real location data from the provided JSON
                const locationData = {
                    "isSuccess": true,
                    "data": {
                        "data": [
                            {
                                "category": {
                                    "id": "hotel",
                                    "name": "Kh√°ch s·∫°n"
                                },
                                "_id": "6704f3650722c4f99305dc5f",
                                "ownerId": "6704df9d3d81e2f463846c27",
                                "name": "Qu√°n Cafe S√°ng T·∫°o",
                                "description": "Qu√°n cafe v·ªõi kh√¥ng gian s√°ng t·∫°o, l√Ω t∆∞·ªüng cho l√†m vi·ªác v√† g·∫∑p g·ª° b·∫°n b√®.",
                                "rating": 3.7,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f7945",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735585136/travel-social/file-1735585106495-pew-nguyen-3sXuWhKZVeg-unsplash.jpg.jpg",
                                        "publicId": "travel-social/file-1735585106495-pew-nguyen-3sXuWhKZVeg-unsplash.jpg"
                                    }
                                ],
                                "address": "789 ƒê∆∞·ªùng L√™ VƒÉn S·ªπ, H√† N·ªôi",
                                "dateCreated": "2024-10-08T03:00:00.000Z",
                                "slug": "quan-cafe-sang-tao-789-uong-le-van-sy-ha-noi",
                                "numberOfRating": 11,
                                "status": "active",
                                "latitude": 21.028511,
                                "longitude": 105.804817,
                                "minPrice": 200000,
                                "province": "H√† N·ªôi"
                            },
                            {
                                "category": {
                                    "id": "hotel",
                                    "name": "kh√°ch s·∫°n"
                                },
                                "_id": "6704f3650722c4f99305dc5d",
                                "ownerId": "6729d0e8dda9481629a2a2e9",
                                "name": "Kh√°ch s·∫°n H∆∞∆°ng Vi·ªát",
                                "description": "Nh√† h√†ng ph·ª•c v·ª• c√°c m√≥n ƒÉn truy·ªÅn th·ªëng Vi·ªát Nam, kh√¥ng gian ·∫•m c√∫ng.",
                                "rating": 3.8,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f7946",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735586344/travel-social/file-1735586315301-3_%20%281%29.jpg.jpg",
                                        "publicId": "travel-social/file-1735586315301-3_ (1).jpg"
                                    },
                                    {
                                        "_id": "6826442d8d082831a30f7947",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735581647/travel-social/file-1735581614030-ystallonne-alves-U_g9ZCqKAPA-unsplash.jpg.jpg",
                                        "publicId": "travel-social/file-1735586315301-3_ (1).jpg"
                                    }
                                ],
                                "address": "123 ƒê∆∞·ªùng Tr·∫ßn H∆∞ng ƒê·∫°o, TP.HCM",
                                "dateCreated": "2024-10-08T03:00:00.000Z",
                                "slug": "nha-hang-huong-viet-123-uong-tran-hung-ao-tphcm",
                                "numberOfRating": 11,
                                "status": "active",
                                "province": "TP.HCM",
                                "minPrice": 300000,
                                "latitude": 10.776889,
                                "longitude": 106.700806
                            },
                            {
                                "category": {
                                    "id": "hotel",
                                    "name": "Nh√† h√†ng"
                                },
                                "numberOfRating": 0,
                                "_id": "6704f3650722c4f99305dc5e",
                                "ownerId": "6704df9d3d81e2f463846c21",
                                "name": "Kh√°ch S·∫°n Bi·ªÉn Xanh",
                                "description": "Kh√°ch s·∫°n ven bi·ªÉn v·ªõi ph√≤ng ngh·ªâ sang tr·ªçng v√† d·ªãch v·ª• tuy·ªát v·ªùi.",
                                "rating": 4,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f7948",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735585013/travel-social/file-1735584983393-simply-mersah-f9VRmJ-eAik-unsplash.jpg.jpg"
                                    }
                                ],
                                "address": "456 ƒê∆∞·ªùng Bi·ªÉn, Nha Trang",
                                "dateCreated": "2024-10-08T03:00:00.000Z",
                                "slug": "khach-san-bien-xanh-456-uong-bien-nha-trang",
                                "status": "active",
                                "latitude": 12.2451,
                                "longitude": 109.1943,
                                "province": "Kh√°nh H√≤a",
                                "minPrice": 200000
                            },
                            {
                                "category": {
                                    "id": "hotel",
                                    "name": "Nh√† h√†ng"
                                },
                                "numberOfRating": 0,
                                "_id": "6704f3650722c4f99305dc60",
                                "ownerId": "6704df9d3d81e2f463846c21",
                                "name": "Kh√°ch s·∫°n Ph·ªë C·ªï",
                                "description": "Nh√† h√†ng v·ªõi c√°c m√≥n ƒÉn ƒë·∫∑c s·∫£n mi·ªÅn B·∫Øc, kh√¥ng gian trang nh√£.",
                                "rating": 4,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f7949",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735585010/travel-social/file-1735584979636-alka-jha-lOxVZQc0W0U-unsplash.jpg.jpg"
                                    }
                                ],
                                "address": "321 ƒê∆∞·ªùng H√†ng B√¥ng, H√† N·ªôi",
                                "dateCreated": "2024-10-08T03:00:00.000Z",
                                "slug": "nha-hang-pho-co-321-uong-hang-bong-ha-noi",
                                "status": "active",
                                "latitude": 21.0251,
                                "longitude": 105.8421,
                                "minPrice": 260000,
                                "province": "H√† N·ªôi"
                            },
                            {
                                "category": {
                                    "id": "hotel",
                                    "name": "Kh√°ch s·∫°n"
                                },
                                "numberOfRating": 0,
                                "_id": "6704f3650722c4f99305dc61",
                                "ownerId": "6704df9d3d81e2f463846c27",
                                "name": "Kh√°ch S·∫°n M·∫∑t Tr·ªùi",
                                "description": "Kh√°ch s·∫°n cao c·∫•p v·ªõi d·ªãch v·ª• spa v√† h·ªì b∆°i sang tr·ªçng.",
                                "rating": 5,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f794a",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735585018/travel-social/file-1735584986518-tu-tran-anh-zfJ0U9MhTUA-unsplash.jpg.jpg"
                                    }
                                ],
                                "address": "654 ƒê∆∞·ªùng Nguy·ªÖn VƒÉn Linh, ƒê√† N·∫µng",
                                "dateCreated": "2024-10-08T03:00:00.000Z",
                                "slug": "khach-san-mat-troi-654-uong-nguyen-van-linh-a-nang",
                                "status": "active",
                                "latitude": 16.0544,
                                "longitude": 108.2022,
                                "minPrice": 400000,
                                "province": "ƒê√† N·∫µng"
                            },
                            {
                                "category": {
                                    "id": "coffee-shop",
                                    "name": "Qu√°n cafe"
                                },
                                "_id": "6704f3650722c4f99305dc62",
                                "ownerId": "6704df9d3d81e2f463846c21",
                                "name": "Kh√°ch S·∫°n B√™n S√¥ng",
                                "description": "Qu√°n cafe y√™n tƒ©nh b√™n s√¥ng, l√Ω t∆∞·ªüng ƒë·ªÉ th∆∞ gi√£n v√† ƒë·ªçc s√°ch.",
                                "rating": 4,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f794b",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735586343/travel-social/file-1735586316946-5_.jpg.jpg",
                                        "publicId": "travel-social/file-1735586316946-5_.jpg"
                                    }
                                ],
                                "address": "135 ƒê∆∞·ªùng B·∫øn V√¢n ƒê·ªìn, TP.HCM",
                                "dateCreated": "2024-10-08T03:00:00.000Z",
                                "slug": "cafe-ben-song-135-uong-ben-van-on-tphcm",
                                "status": "active",
                                "numberOfRating": 2
                            },
                            {
                                "category": {
                                    "id": "guest home",
                                    "cateName": "Qu√°n cafe"
                                },
                                "numberOfRating": 0,
                                "_id": "6719247c456a0d466dc2be77",
                                "ownerId": "671917a9dba9bb66474be6f4",
                                "name": "Nh√† ngh·ªâ six",
                                "description": "Qu√°n cafe v·ªõi kh√¥ng gian s√°ng t·∫°o, l√Ω t∆∞·ªüng cho l√†m vi·ªác v√† g·∫∑p g·ª° b·∫°n‚Ä¶",
                                "rating": 0,
                                "image": [
                                    {
                                        "_id": "6826442d8d082831a30f794c",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735586343/travel-social/file-1735586313501-1_%20%281%29.jpg.jpg",
                                        "publicId": "travel-social/file-1735586313501-1_ (1).jpg"
                                    }
                                ],
                                "address": "789 ƒê∆∞·ªùng L√™ VƒÉn S·ªπ, H√† N·ªôi",
                                "dateCreated": "2024-10-23T16:29:48.970Z",
                                "__v": 0,
                                "slug": "six-coffee-789-uong-le-van-sy-ha-noi",
                                "status": "active"
                            },
                            {
                                "category": {
                                    "id": "hotel"
                                },
                                "_id": "6772e1d9d9ed3a046ab7d136",
                                "ownerId": "671a02c2c0202050e0969548",
                                "name": "LAVENDER HOTEL",
                                "description": "Kh√°ch s·∫°n sang tr·ªçng v·ªõi c√°c ph√≤ng ƒë∆∞·ª£c thi·∫øt k·∫ø tinh t·∫ø, trang b·ªã TV m√†n h√¨nh ph·∫≥ng, minibar, v√† Wi-Fi mi·ªÖn ph√≠.",
                                "rating": 0,
                                "numberOfRating": 0,
                                "image": [
                                    {
                                        "_id": "6772e1d9d9ed3a046ab7d137",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735582191/travel-social/file-1735582162387-6f9a2ebe.avif.avif"
                                    }
                                ],
                                "address": "07 ƒë∆∞·ªùng 41, Ph∆∞·ªùng 6, Qu·∫≠n 4, TP. HCM",
                                "province": "TP.HCM",
                                "dateCreated": "2024-12-30T18:09:29.791Z",
                                "status": "active",
                                "minPrice": 350000
                            },
                            {
                                "category": {
                                    "id": "hotel",
                                    "name": "Kh√°ch s·∫°n"
                                },
                                "_id": "6772e4e9297d75e3d50f587d",
                                "ownerId": "671a02c2c0202050e0969548",
                                "name": "Kh√°ch s·∫°n Minh H·∫±ng 2",
                                "description": "Kh√°ch s·∫°n cao c·∫•p v·ªõi d·ªãch v·ª• spa v√† h·ªì b∆°i sang tr·ªçng.",
                                "rating": 4.5,
                                "numberOfRating": 0,
                                "image": [
                                    {
                                        "_id": "6772e4e9297d75e3d50f587e",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735582975/travel-social/file-1735582946714-6f9a2ebe.avif.avif"
                                    }
                                ],
                                "address": "152 ng√¥ thuy·ªÅn, Ph∆∞·ªùng Qu·∫£ng Th·∫Øng, Th√†nh ph·ªë Thanh H√≥a",
                                "province": "Thanh H√≥a",
                                "dateCreated": "2024-12-30T18:22:33.742Z",
                                "status": "active",
                                "minPrice": 280000
                            },
                            {
                                "category": {
                                    "id": "guest home"
                                },
                                "_id": "6772e57e297d75e3d50f5888",
                                "ownerId": "671a02c2c0202050e0969548",
                                "name": "Nh√† ngh·ªâ Nh·∫≠t Quang",
                                "description": "Nh√† ngh·ªâ ti·ªán nghi g·∫ßn h·ªì Ba B·ªÉ, ph·ª•c v·ª• t·ªët cho du kh√°ch thƒÉm quan v√πng n√∫i ph√≠a B·∫Øc.",
                                "rating": 4.2,
                                "numberOfRating": 0,
                                "image": [
                                    {
                                        "_id": "6772e57e297d75e3d50f5889",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735583127/travel-social/file-1735583098276-77807812.avif.avif"
                                    }
                                ],
                                "address": "Th√¥n C·ªëc T·ªôc, x√£ Nam M·∫´u, huy·ªán Ba B·ªÉ, t·ªânh B·∫Øc K·∫°n",
                                "province": "B·∫Øc K·∫°n",
                                "dateCreated": "2024-12-30T18:25:02.226Z",
                                "status": "active",
                                "minPrice": 180000
                            },
                            {
                                "category": {
                                    "id": "hotel"
                                },
                                "_id": "6772e623297d75e3d50f588f",
                                "ownerId": "671a02c2c0202050e0969548",
                                "name": "Ivy Hotel",
                                "description": "Kh√°ch s·∫°n hi·ªán ƒë·∫°i v·ªõi view ƒë·∫πp nh√¨n ra v·ªãnh H·∫° Long, d·ªãch v·ª• ·∫©m th·ª±c cao c·∫•p.",
                                "rating": 4.8,
                                "numberOfRating": 0,
                                "image": [
                                    {
                                        "_id": "6772e623297d75e3d50f5890",
                                        "url": "https://res.cloudinary.com/dzy4gcw1k/image/upload/v1735583282/travel-social/file-1735583253641-c9c8e087.avif.avif"
                                    }
                                ],
                                "address": "S·ªë 18 - Ng√µ 1 - v∆∞·ªùn ƒë√†o- ph∆∞·ªùng b√£i ch√°y - Th√†nh Ph·ªë h·∫° Long",
                                "province": "Qu·∫£ng Ninh",
                                "dateCreated": "2024-12-30T18:27:47.540Z",
                                "status": "active",
                                "minPrice": 450000
                            }
                        ],
                        "total": 55,
                        "page": 1,
                        "limit": 20
                    },
                    "error": null
                };
                
                // Map the location data to product format for our UI
                const products = locationData.data.data.filter(location => location.status === "active").map((location, index) => {
                    return {
                        product_id: location._id, // Use the location ID as product ID
                        name: location.name,
                        description: location.description || "Kh√¥ng c√≥ m√¥ t·∫£",
                        price: location.minPrice ? (location.minPrice / 1000).toFixed(0) + "k VND" : "N/A",
                        rating: location.rating || 0,
                        image: location.image && location.image.length > 0 ? location.image[0].url : null,
                        address: location.address,
                        province: location.province || "",
                        category: location.category ? (location.category.name || location.category.id) : "ƒê·ªãa ƒëi·ªÉm",
                        latitude: location.latitude,
                        longitude: location.longitude
                    };
                });
                  displayProducts(products);
                
                // Initialize map and add markers
                initMap();
                addLocationMarkers(products);
                addProductCardClickHandlers(products);
            } catch (error) {
                logMessage(`Error fetching products: ${error.message}`, 'error');
            }
        }

        // Display products in the UI
        function displayProducts(products) {
            productList.innerHTML = ''; // Clear existing products
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.product_id;
                
                // Create image HTML if image is available
                const imageHtml = product.image ? 
                    `<div class="product-image">
                        <img src="${product.image}" alt="${product.name}" style="width:100%; height:150px; object-fit:cover; border-radius:3px;">
                    </div>` : '';
                
                card.innerHTML = `
                    ${imageHtml}
                    <h3>${product.name}</h3>
                    <p class="category">${product.category}</p>
                    <p class="address"><i>${product.address}</i></p>
                    <p>${product.description.length > 100 ? product.description.substring(0, 100) + '...' : product.description}</p>
                    <p><strong>Gi√° t·ª´:</strong> ${product.price}</p>
                    <p><strong>T·ªânh/TP:</strong> ${product.province}</p>
                    <p><strong>ƒê√°nh gi√°:</strong> ${product.rating}/5</p>
                    <div class="actions">
                        <button class="view-btn" data-id="${product.product_id}">Xem</button>
                        <button class="cart-btn" data-id="${product.product_id}">L∆∞u</button>
                        <button class="purchase-btn" data-id="${product.product_id}">ƒê·∫∑t</button>
                    </div>
                `;
                
                productList.appendChild(card);
            });
            
            // Add event handlers for buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleProductAction(e, 'view'));
            });
            
            document.querySelectorAll('.cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleProductAction(e, 'add_to_cart'));
            });
              document.querySelectorAll('.purchase-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleProductAction(e, 'purchase'));
            });
            
            // Add click handlers for the product cards to show their location on the map
            addProductCardClickHandlers(products);
        }

        // Handle product actions (view, add to cart, purchase)
        async function handleProductAction(event, actionType) {
            const productId = event.target.dataset.id;
            
            if (!connected) {
                logMessage('Vui l√≤ng k·∫øt n·ªëi ng∆∞·ªùi d√πng tr∆∞·ªõc', 'error');
                return;
            }
            
            try {
                // Map action types to Vietnamese for logging
                const actionLabels = {
                    'view': 'Xem',
                    'add_to_cart': 'L∆∞u',
                    'purchase': 'ƒê·∫∑t'
                };
                
                const response = await fetch(`${apiBaseUrl}/event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        product_id: productId,
                        event_type: actionType
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    logMessage(`L·ªói: ${data.error}`, 'error');
                } else {
                    logMessage(`ƒê√£ ghi nh·∫≠n s·ª± ki·ªán: ${actionLabels[actionType]} ƒë·ªãa ƒëi·ªÉm ${productId}`, 'success');
                    
                    // If recommendations are included in the response and not sent via websocket, display them
                    if (data.recommendations && !data.sent_via_socket) {
                        displayRecommendations(data.recommendations);
                    }
                }
                
            } catch (error) {
                logMessage(`L·ªói khi ghi nh·∫≠n s·ª± ki·ªán: ${error.message}`, 'error');
            }
        }

        // Fetch recommendations from the API
        async function fetchRecommendations(userId) {
            try {
                const response = await fetch(`${apiBaseUrl}/realtime-recommend?user_id=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    logMessage(`L·ªói: ${data.error}`, 'error');
                } else {
                    logMessage('ƒê√£ t·∫£i ƒë·ªÅ xu·∫•t ban ƒë·∫ßu', 'info');
                    displayRecommendations(data.recommendations);
                }
                
            } catch (error) {
                logMessage(`L·ªói khi t·∫£i ƒë·ªÅ xu·∫•t: ${error.message}`, 'error');
            }
        }

        // Display recommendations in the UI
        function displayRecommendations(recommendations) {
            recommendationList.innerHTML = ''; // Clear existing recommendations
            
            if (!recommendations || recommendations.length === 0) {
                const item = document.createElement('div');
                item.className = 'rec-item';
                item.textContent = 'Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t n√†o';
                recommendationList.appendChild(item);
                return;
            }
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'rec-item';
                
                // Create image HTML if image is available
                const imageHtml = rec.image ? 
                    `<div class="rec-image">
                        <img src="${rec.image}" alt="${rec.name}" style="width:100%; height:120px; object-fit:cover; border-radius:3px; margin-bottom:8px;">
                    </div>` : '';
                
                // Create HTML content based on available properties
                let content = imageHtml;
                
                if (rec.name) {
                    content += `<h3>${rec.name}</h3>`;
                } else if (rec.product_id) {
                    content += `<h3>ƒê·ªãa ƒëi·ªÉm ${rec.product_id}</h3>`;
                }
                
                if (rec.category) {
                    content += `<p class="category">${rec.category}</p>`;
                }
                
                if (rec.address) {
                    content += `<p class="address"><i>${rec.address}</i></p>`;
                }
                
                if (rec.description) {
                    content += `<p>${rec.description.length > 100 ? rec.description.substring(0, 100) + '...' : rec.description}</p>`;
                }
                
                if (rec.price) {
                    content += `<p><strong>Gi√° t·ª´:</strong> ${rec.price}</p>`;
                }
                
                if (rec.province) {
                    content += `<p><strong>T·ªânh/TP:</strong> ${rec.province}</p>`;
                }
                
                if (rec.rating) {
                    content += `<p><strong>ƒê√°nh gi√°:</strong> ${rec.rating}/5</p>`;
                }
                
                if (rec.score) {
                    content += `<p><strong>ƒêi·ªÉm ƒë·ªÅ xu·∫•t:</strong> ${parseFloat(rec.score).toFixed(2)}</p>`;
                }
                
                if (rec.source) {
                    content += `<p><strong>Ngu·ªìn ƒë·ªÅ xu·∫•t:</strong> ${rec.source}</p>`;
                }
                  item.innerHTML = content;
                item.dataset.id = rec.product_id || "";
                
                // Add click handler to highlight on map if coordinates are available
                if (rec.latitude && rec.longitude) {
                    item.style.cursor = "pointer";
                    item.addEventListener('click', () => {
                        map.setView([rec.latitude, rec.longitude], 14);
                        
                        // Find or create marker
                        let found = false;
                        markers.forEach(marker => {
                            const pos = marker.getLatLng();
                            if (pos.lat === rec.latitude && pos.lng === rec.longitude) {
                                marker.openPopup();
                                found = true;
                            }
                        });
                        
                        // If no existing marker, create one temporarily
                        if (!found) {
                            const marker = L.marker([rec.latitude, rec.longitude])
                                .addTo(map)
                                .bindPopup(`
                                    <strong>${rec.name}</strong><br/>
                                    ${rec.address || ''}<br/>
                                    <small>${rec.category || ''}</small>
                                `).openPopup();
                            markers.push(marker);
                        }
                    });
                }
                
                recommendationList.appendChild(item);
            });
        }        // Map functionality
        let map;
        let markers = [];
        
        // Initialize map
        function initMap() {
            // Center on Vietnam
            map = L.map('map').setView([16.0544, 108.2022], 5);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            logMessage("B·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o", "info");
        }
        
        // Add markers for all locations to the map
        function addLocationMarkers(products) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers
            products.forEach(product => {
                if (product.latitude && product.longitude) {
                    const marker = L.marker([product.latitude, product.longitude])
                        .addTo(map)
                        .bindPopup(`
                            <strong>${product.name}</strong><br/>
                            ${product.address}<br/>
                            <small>${product.category || ''}</small>
                        `);
                    markers.push(marker);
                }
            });
            
            if (markers.length > 0) {
                logMessage(`ƒê√£ hi·ªÉn th·ªã ${markers.length} ƒë·ªãa ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì`, "info");
            } else {
                logMessage("Kh√¥ng c√≥ d·ªØ li·ªáu v·ªã tr√≠ ƒë·ªÉ hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì", "info");
            }
        }        // Highlight a product on the map
        function highlightLocationOnMap(productId, products) {
            const product = products.find(p => p.product_id === productId);
            
            if (product && product.latitude && product.longitude) {
                // Zoom to the location
                map.setView([product.latitude, product.longitude], 14);
                
                // Find the marker and open its popup
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (markerLatLng.lat === product.latitude && markerLatLng.lng === product.longitude) {
                        marker.openPopup();
                    }
                });
                
                logMessage(`ƒê√£ ƒë·ªãnh v·ªã "${product.name}" tr√™n b·∫£n ƒë·ªì`, "info");
            } else {
                logMessage("Kh√¥ng c√≥ d·ªØ li·ªáu v·ªã tr√≠ cho ƒë·ªãa ƒëi·ªÉm n√†y", "error");
            }
        }
        
        // Add click handler for the entire product card
        function addProductCardClickHandlers(products) {
            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // Only handle clicks on the card itself, not on buttons
                    if (!e.target.classList.contains('view-btn') && 
                        !e.target.classList.contains('cart-btn') && 
                        !e.target.classList.contains('purchase-btn')) {
                        const productId = this.dataset.id;
                        highlightLocationOnMap(productId, products);
                    }
                });
            });
        }        // Event listeners
        connectBtn.addEventListener('click', connectSocket);
        disconnectBtn.addEventListener('click', disconnectSocket);

        // Welcome message
        function showWelcomeMessage() {
            logMessage("Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng ƒë·ªÅ xu·∫•t ƒë·ªãa ƒëi·ªÉm du l·ªãch theo th·ªùi gian th·ª±c!", "info");
            logMessage("Nh·∫≠p ID ng∆∞·ªùi d√πng v√† nh·∫•p 'K·∫øt n·ªëi' ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n ƒë·ªÅ xu·∫•t.", "info");
        }

        // Initialize
        fetchProducts();
        updateConnectionUI();
        showWelcomeMessage();
        initMap();
    </script>
</body>
</html>
